# Fragment Types

Fragments are the parsed components of workout script statements. Each fragment represents a specific workout metric, action, or value.

## Overview

Fragments are created by the parser when it processes workout scripts and are passed to the JIT compiler for block creation. All fragments implement the `ICodeFragment` interface.

## ICodeFragment

Base interface for all fragment types.

### Properties

| Property | Type | Description |
|-----------|-------|-------------|
| `image` | `string` | String representation of the value |
| `value` | `any` | The parsed value (type varies by fragment) |
| `type` | `string` | Legacy type identifier (retained for compatibility) |
| `fragmentType` | `FragmentType` | Enum discriminator for fragment type |
| `meta` | `CodeMetadata` | Source code location metadata |
| `collectionState` | `FragmentCollectionState` | State of value collection |
| `behavior` | `MetricBehavior` | Behavioral grouping hint |

## FragmentType Enum

```typescript
enum FragmentType {
  Timer = 'timer',
  Rep = 'rep',
  Effort = 'effort',
  Distance = 'distance',
  Rounds = 'rounds',
  Action = 'action',
  Increment = 'increment',
  Lap = 'lap',
  Text = 'text',
  Resistance = 'resistance'
}
```

## FragmentCollectionState Enum

State of a fragment's value, used for collectible metrics.

```typescript
enum FragmentCollectionState {
  Defined = 'defined',              // Value is fully specified (default)
  RuntimeGenerated = 'runtime-generated',  // Value generated by runtime (e.g., elapsed time)
  UserCollected = 'user-collected',    // Value collected from user input
  Collected = 'collected',            // Value has been collected and populated
  Hinted = 'hinted',                  // Value is a hint/suggestion
  Tracked = 'tracked',                // Value is actively being tracked during execution
  Analyzed = 'analyzed'              // Value is derived from analysis
}
```

## TimerFragment

Represents a time duration in the workout script.

### Constructor

```typescript
constructor(
  image: string,
  meta: CodeMetadata,
  forceCountUp: boolean = false
)
```

**Parameters:**

| Parameter | Type | Description |
|-----------|-------|-------------|
| `image` | `string` | Timer string (e.g., "5:00", "1:30:00") or ":?" for collectible |
| `meta` | `CodeMetadata` | Source code location |
| `forceCountUp` | `boolean` | If true, timer counts up even with explicit duration |

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `number | undefined` | Duration in milliseconds (undefined if collectible) |
| `days` | `number` | Days component (0-∞) |
| `hours` | `number` | Hours component (0-23) |
| `minutes` | `number` | Minutes component (0-59) |
| `seconds` | `number` | Seconds component (0-59) |
| `original` | `number | undefined` | Original parsed value in ms |
| `direction` | `'up' | 'down'` | Timer direction (computed from value) |
| `type` | `string` | "duration" |
| `fragmentType` | `FragmentType` | `FragmentType.Timer` |
| `collectionState` | `FragmentCollectionState` | Defined or RuntimeGenerated |

### Direction Computation

- `forceCountUp = true` → Always `'up'`
- `value > 0` → `'down'` (countdown)
- `value === 0` or `undefined` → `'up'` (count-up)

**Examples:**

```typescript
// Countdown timer
const timer1 = new TimerFragment("5:00", meta);
console.log(timer1.value);      // 300000 (5 minutes in ms)
console.log(timer1.direction);  // 'down'

// Count-up timer
const timer2 = new TimerFragment("0:00", meta);
console.log(timer2.direction);  // 'up'

// Collectible timer
const timer3 = new TimerFragment(":?", meta);
console.log(timer3.value);      // undefined
console.log(timer3.collectionState);  // 'runtime-generated'
```

## RepFragment

Represents a repetition count.

### Constructor

```typescript
constructor(reps?: number, meta?: CodeMetadata)
```

**Parameters:**

| Parameter | Type | Description |
|-----------|-------|-------------|
| `reps` | `number | undefined` | Repetition count (undefined for collectible) |
| `meta` | `CodeMetadata` | Source code location |

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `number | undefined` | Repetition count |
| `image` | `string` | String representation ("?" if collectible) |
| `type` | `string` | "rep" |
| `fragmentType` | `FragmentType` | `FragmentType.Rep` |
| `collectionState` | `FragmentCollectionState` | Defined or UserCollected |

**Examples:**

```typescript
// Fixed reps
const reps1 = new RepFragment(10, meta);
console.log(reps1.value);  // 10
console.log(reps1.image);  // "10"

// Collectible reps
const reps2 = new RepFragment(undefined, meta);
console.log(reps2.value);  // undefined
console.log(reps2.image);  // "?"
```

## EffortFragment

Represents an effort level or intensity for an exercise.

**Purpose:** Captures subjective effort or intensity levels like "RPE 7" or "moderate".

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `string` | Effort description or level |
| `type` | `string` | "effort" |
| `fragmentType` | `FragmentType` | `FragmentType.Effort` |

**Examples:**

```typescript
// Effort levels typically come in forms like:
// - "RPE 7" (Rate of Perceived Exertion)
// - "moderate"
// - "hard"
// - "easy"
```

## DistanceFragment

Represents a distance measurement.

**Purpose:** Captures distances for running, rowing, cycling, etc.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `number` | Distance value |
| `unit` | `string` | Unit of measurement (meters, miles, km, etc.) |
| `type` | `string` | "distance" |
| `fragmentType` | `FragmentType` | `FragmentType.Distance` |

**Examples:**

```typescript
// 5k run
const distance = new DistanceFragment(5, "km");

// 1000m row
const row = new DistanceFragment(1000, "meters");
```

## ResistanceFragment

Represents weight or resistance for strength exercises.

**Purpose:** Captures load amounts for exercises like squats, deadlifts, etc.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `number` | Weight/resistance amount |
| `unit` | `string` | Unit of measurement (kg, lbs, etc.) |
| `type` | `string` | "resistance" |
| `fragmentType` | `FragmentType` | `FragmentType.Resistance` |

**Examples:**

```typescript
// 135lb squat
const squat = new ResistanceFragment(135, "lbs");

// 60kg press
const press = new ResistanceFragment(60, "kg");
```

## RoundsFragment

Represents a round count for workout structure.

**Purpose:** Defines the number of rounds or rep schemes.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `number` | Number of rounds |
| `repScheme` | `number[] | undefined` | Optional rep scheme (e.g., [21, 15, 9]) |
| `type` | `string` | "rounds" |
| `fragmentType` | `FragmentType` | `FragmentType.Rounds` |

**Examples:**

```typescript
// Fixed rounds: "3 Rounds"
const fixed = new RoundsFragment(3);

// Rep scheme: "21-15-9"
const scheme = new RoundsFragment(undefined, [21, 15, 9]);
```

## ActionFragment

Represents an action or instruction in the workout.

**Purpose:** Captures actions like "rest", "transition", or custom instructions.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `string` | Action name or description |
| `type` | `string` | "action" |
| `fragmentType` | `FragmentType` | `FragmentType.Action` |

**Examples:**

```typescript
// Rest period
const rest = new ActionFragment("rest");

// Transition
const transition = new ActionFragment("transition");

// Custom instruction
const note = new ActionFragment("keep core tight");
```

## IncrementFragment

Represents an increment value for progressive tracking.

**Purpose:** Used for tracking incremental progress during exercises.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `number` | Increment amount |
| `type` | `string` | "increment" |
| `fragmentType` | `FragmentType` | `FragmentType.Increment` |

**Examples:**

```typescript
// Increment by 5 reps
const increment = new IncrementFragment(5);
```

## LapFragment

Represents a lap marker for multi-segment workouts.

**Purpose:** Marks lap boundaries in interval or EMOM workouts.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `number` | Lap number |
| `type` | `string` | "lap" |
| `fragmentType` | `FragmentType` | `FragmentType.Lap` |

**Examples:**

```typescript
// First lap
const lap1 = new LapFragment(1);

// Second lap
const lap2 = new LapFragment(2);
```

## TextFragment

Represents descriptive text in the workout.

**Purpose:** Captures notes, instructions, or labels.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `value` | `string` | Text content |
| `type` | `string` | "text" |
| `fragmentType` | `FragmentType` | `FragmentType.Text` |

**Examples:**

```typescript
// Workout note
const note = new TextFragment("Maintain good form throughout");

// Section header
const header = new TextFragment("Warm-up");
```

## Fragment Usage in Workout Scripts

### Example 1: Simple EMOM

```
Every 1 minute for 5 minutes:
- 10 Push-ups
- 15 Squats
```

**Generated Fragments:**
- `TimerFragment("1:00", meta)` - Interval duration
- `TimerFragment("5:00", meta)` - Total duration
- `RepFragment(10, meta)` - Push-up count
- `RepFragment(15, meta)` - Squat count

### Example 2: AMRAP

```
AMRAP 10 minutes:
- 5 Deadlifts @ 135lb
- 10 Pull-ups
- 20 Double-unders
```

**Generated Fragments:**
- `TimerFragment("10:00", meta)` - Time limit
- `RepFragment(5, meta)` - Deadlift count
- `ResistanceFragment(135, "lbs", meta)` - Load
- `RepFragment(10, meta)` - Pull-up count
- `RepFragment(20, meta)` - Double-under count

### Example 3: Rep Scheme

```
3 Rounds of 21-15-9:
- Thrusters @ 95lb
- Pull-ups
```

**Generated Fragments:**
- `RoundsFragment(3, [21, 15, 9], meta)` - Round count and scheme
- `RepFragment(21, meta)` - Round 1 reps
- `RepFragment(15, meta)` - Round 2 reps
- `RepFragment(9, meta)` - Round 3 reps
- `ResistanceFragment(95, "lbs", meta)` - Load

## Collection States and User Input

Fragments can be marked for collection when their value depends on user input or runtime generation:

### User-Collected

Reps or loads that vary by athlete:

```typescript
// ? indicates collectible
const unknownReps = new RepFragment(undefined, meta);
console.log(unknownReps.collectionState); // 'user-collected'
```

### Runtime-Generated

Timers that track elapsed time:

```typescript
// :? indicates runtime-generated timer
const elapsedTime = new TimerFragment(":?", meta);
console.log(elapsedTime.collectionState); // 'runtime-generated'
```

## Fragment to Block Mapping

The JIT compiler matches fragment patterns to create specific block types:

| Fragment Pattern | Block Type | Strategy |
|----------------|-------------|-----------|
| `TimerFragment` + `RoundsFragment` | AMRAPBlock | TimeBoundRoundsStrategy |
| `TimerFragment` + `behavior.repeating_interval` | EMOMBlock | IntervalStrategy |
| `TimerFragment` (alone or with children) | TimerBlock | TimerStrategy |
| `RoundsFragment` (no timer) | RoundsBlock | RoundsStrategy |
| No timer, no rounds | EffortBlock | EffortStrategy |
| Has children | GroupBlock | GroupStrategy |

## See Also

- [Runtime System](./runtime-system.md) - How fragments become blocks
- [Parser System](./parser-system.md) - How fragments are created
- [Block Types Reference](../block-types-behaviors-reference.md) - Block behavior details
