# UI Alignment - Remaining Tasks (Phase 3)

## Overview
This document outlines the remaining work to complete the UI Alignment Phase 3, ensuring all components adhere to the new stack-driven runtime architecture.

##  Critical Components (Immediate Action)

### 1. StackedClockDisplay.tsx (PARTIALLY COMPLETE)
- **Status**: Refactored to use `useStackTimers`, `usePrimaryTimer`, `useStackDisplayItems`.
- **Remaining**:
  - Verify `roundInfo` calculation handles all block types.
  - Test `PrimaryTimerSection` with real runtime updates.
  - Verify `StackDebugView` renders correctly with new mapped types.

### 2. WorkoutTestHarness.ts
- **Status**: Broken (`tracker` property missing from Runtime).
- **Task**: 
  - Update `getReport()` to derive spans from logic other than `runtime.tracker`.
  - Alternatively, restore `RuntimeReporter` as a side-car listener subscribed to `runtime.getOutputStatements()`.

### 3. useDisplayStack.ts
- **Status**: Deprecated/Broken.
- **Task**: 
  - Identify any remaining consumers (`index.ts` re-exports).
  - Mark as `@deprecated`.
  - Delete file once `StackedClockDisplay` is verified stable.

##  Important Components (Cleanup)

### 1. ExecutionTracker.ts / RuntimeReporter
- **Issue**: Assumes legacy `IRuntimeMemory` interface.
- **Task**:
  - Refactor to listen to `OutputStatements` (generated by Blocks) and build `RuntimeSpan` history.
  - Decouple from explicit `memory` dependency.

### 2. RuntimeDebugPanel.tsx
- **Issue**: Uses `RuntimeAdapter` which might mix new/old memory patterns.
- **Task**: 
  - Verify `RuntimeAdapter` correctly extracts `round`, `timer`, and `segment` memory from Blocks.
  - Ensure Debug Panel shows the same state as the Clock Display.

## Step-by-Step Task List

### Step 1: Stabilize Test Infrastructure
- [ ] Fix `WorkoutTestHarness.getReport()` to stop crashing.
- [ ] Verify unit tests for `StackedClockDisplay` (create if missing).

### Step 2: Verify Clock Display
- [ ] Run Storybook `Clock > StackedClockDisplay`.
- [ ] Test "Start", "Pause", "Resume" flows.
- [ ] Verify "Round 1/X" display works for AMRAP/ForTime.

### Step 3: Deprecate Legacy Legacy
- [ ] Remove `src/clock/hooks/useDisplayStack.ts`.
- [ ] Remove unused types from `src/clock/types/DisplayTypes.ts`.
- [ ] Delete `ExecutionTracker` if `RuntimeReporter` functionality is moved.

### Step 4: Finalize Analytics
- [ ] Ensure `getAnalyticsFromRuntime()` (in `AnalyticsTransformer.ts`) works with the new `OutputStatement` format.
- [ ] Verify end-of-workout summary screen.

## Notes
- **Do not revert** to `runtime.memory.search()`. Always use `block.getMemory()` or stack subscriptions.
- **Keep `StackedClockDisplay` logic self-contained** (using hooks) rather than relying on global display state objects.

