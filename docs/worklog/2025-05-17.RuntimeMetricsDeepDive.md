# Wod.Wiki - Runtime Metrics Deep Dive

## 1. Introduction

### 1.1. Purpose
This document provides a detailed explanation of the runtime metrics system within Wod.Wiki. It covers how metrics are defined, generated, aggregated, tracked internally, and displayed in the user interface. Understanding this system is crucial for developers working on the runtime engine, UI components related to results display, or extending workout tracking capabilities.

### 1.2. Importance of Metrics
Runtime metrics are the quantitative record of a user's performance during a workout. They provide valuable feedback, enable progress tracking, and form the basis for analytics. Accurate and comprehensive metrics are key to the user experience.

## 2. `RuntimeMetric` Data Structure (`timer.types.ts`)

The core data structure for representing metrics is `RuntimeMetric`.

- **`RuntimeMetric`**:
  - `effort: string`: The name or description of the exercise or effort.
  - `repetitions: number`: The count of repetitions performed.
  - `resistance?: MetricValue`: Optional. The weight or resistance used.
  - `distance?: MetricValue`: Optional. The distance covered.
  (MEMORY[74eb0117-4e09-4991-bdfd-20d4a63f10cc])

- **`MetricValue`**:
  - `value: number`: The numerical value of the metric.
  - `unit: string`: The unit of measurement (e.g., "kg", "lb", "m", "km", "ft").

This structure ensures consistency in how different types of performance data are handled throughout the application.

## 3. Metrics Generation

Metrics are initially generated during the parsing and compilation phases, primarily from `Fragment`s within `PrecompiledNode`s.

- **Reader Functions**: Utility functions, such as `getMetrics` (located in `src/core/runtime/blocks/readers/getRounds.ts`), are responsible for extracting fragment data (e.g., `EffortFragment`, `RepFragment`, `ResistanceFragment`, `DistanceFragment`) from a `PrecompiledNode` and assembling an initial `RuntimeMetric` object.
- **`AbstractBlockLifecycle`**: When a runtime block is created, its `AbstractBlockLifecycle` often initializes a `MetricsContext` for it, potentially using a `MetricsFactory`, which might take these initially parsed metrics as a base. (MEMORY[a377972a-fc4e-4d35-99ec-0f91d2e63473])

## 4. `MetricsContext` and Aggregation

Each runtime block instance manages its metrics through a `MetricsContext`.

- **`MetricsContext`**:
  - Holds the `RuntimeMetric` data for the block.
  - Is governed by a `MetricsRelationshipType` which defines how its metrics relate to its parent and child blocks. (MEMORY[a377972a-fc4e-4d35-99ec-0f91d2e63473])
- **`MetricsRelationshipType`**: (MEMORY[a377972a-fc4e-4d35-99ec-0f91d2e63473])
  - `ADD`: Metrics from child blocks are summed up and added to this block's metrics (e.g., `RootBlock`, `TimedGroupBlock`).
  - `MULTIPLY`: Metrics from this block are multiplied by a factor (e.g., number of rounds in a `RepeatingBlock`). The `RepeatingBlock` itself might also generate "Round Complete" type metrics.
  - `INHERIT`: The block directly uses or passes through the metrics defined at its level, typically from its source `PrecompiledNode` (e.g., `EffortBlock` often inherits its base effort, reps, resistance directly).
- **Aggregation**: The `getMetrics()` method of a `MetricsContext` is responsible for calculating the block's total metrics, which includes applying its relationship type and aggregating metrics from any child blocks.

## 5. `ResultSpan`

A `ResultSpan` captures the final, consolidated metrics for a single execution instance of a block.

- **Generation**: (MEMORY[a377972a-fc4e-4d35-99ec-0f91d2e63473])
  - Managed by `BlockContext` and `AbstractBlockLifecycle`.
  - Concrete block types override `AbstractBlockLifecycle.enhanceResultSpan()` to populate their `ResultSpan` with specific metrics. This method is called when a block is completing its current execution.
  - For example:
    - `EffortBlock` typically populates the span with its inherited/base metrics.
    - `RepeatingBlock` might populate with multiplied metrics or summary "round" metrics.
    - `TimedGroupBlock` and `RootBlock` populate with aggregated metrics from their children.
- **Content**: A `ResultSpan` includes:
  - The duration of the block's execution.
  - The fully calculated `RuntimeMetric` object for that execution.
- **Emission**: The `ResultSpan` is typically emitted or finalized when the block completes its lifecycle (e.g., during the `leave` phase). This data is then available for UI display and logging.

## 6. Internal State Tracking & Flow

Metrics are an integral part of the runtime's state.

- **`RuntimeStack`**: As blocks are pushed onto and popped from the `RuntimeStack`, their `BlockContext` (containing `MetricsContext` and `ResultSpan` data) is managed.
- **Data Flow**:
  1. Raw fragments are parsed into `PrecompiledNode`s.
  2. `RuntimeJit` strategies compile `PrecompiledNode`s into `IRuntimeBlock`s.
  3. `AbstractBlockLifecycle` initializes `MetricsContext` for each block, using initial metrics from the node.
  4. As a block executes (`enter`, `next`, `leave` phases):
     - It may update its own `MetricsContext` based on its logic.
     - It may trigger child blocks.
     - Upon completion of a child, the parent block may aggregate the child's `ResultSpan` metrics into its own `MetricsContext` according to its `MetricsRelationshipType`.
  5. When a block itself completes, its `enhanceResultSpan()` method finalizes its `ResultSpan`, which is then stored/emitted.
- **`BlockContext`**: Holds the `MetricsContext` and the list of `ResultSpan`s generated by a block (if it can run multiple times or has sub-elements that generate spans).

## 7. UI Display and Expectations

The UI presents metrics to the user in a clear and understandable manner.

- **Key UI Components** (MEMORY[74eb0117-4e09-4991-bdfd-20d4a63f10cc]):
  - `WodResults`: Displays a summary or detailed breakdown of completed workout metrics.
  - `WodTable`: May show metrics in a tabular format, possibly per round or per exercise.
  - `EventsView`: Could show a log of `ResultSpan` emissions, providing a granular view of metrics generation.
  - `WodResultsSectionHead`: Shows summary metrics with even spacing.
- **Visual Cues**:
  - Icons are used to differentiate metric types (e.g., 💪 for resistance, 📏 for distance).
  - Units are always displayed alongside values.
- **Real-time Updates**: Some UI elements might update metrics in real-time as blocks complete and emit `ResultSpan`s, while others might update only at the end of the workout.
- **Clarity**: The UI should clearly distinguish between metrics for individual efforts, rounds, and the total workout.

## 8. Metrics in Group Operations (MEMORY[eddef35c-1130-4575-b2a2-0339144edb59])

The group operators affect how metrics are aggregated:

- **Round-Robin Operator (`-`)**: Metrics for each child item are typically logged individually as they are completed in their respective turns within the parent round. Aggregation at the parent level would sum these individual `ResultSpan`s.
- **Compose Operator (`+`)**: All children are executed as a single unit per parent round. The `MetricsContext` of the parent (or a `TimedGroupBlock` if applicable) would use `ADD` relationship to sum metrics from all children for that composed unit.
- **Repeat (No Operator)**: Each child individually goes through all parent rounds. The `RepeatingBlock` (parent) would likely use a `MULTIPLY` relationship for each child's metrics over the rounds, or sum the `ResultSpan`s from each child's full set of repetitions.

The specific `IRuntimeBlock` and `IRuntimeBlockStrategy` implementations for these group operations will define the precise metric aggregation logic.

## 9. Example Scenario: `3 Rounds of (Push Press 5 reps @60kg, 10 Cal Row)`

1.  **Parsing**:
    -   Parent `PrecompiledNode` (Repeating, 3 rounds)
        -   Child `PrecompiledNode` ("Push Press", 5 reps, 60kg) -> `EffortFragment`, `RepFragment`, `ResistanceFragment`
        -   Child `PrecompiledNode` ("10 Cal Row") -> `EffortFragment`, `RepFragment` (value 10, unit "Cal")

2.  **Runtime - Round 1**:
    -   `RepeatingBlock` (3 rounds) `enters`. `MetricsContext` (MULTIPLY).
    -   `EffortBlock` ("Push Press") `enters`. `MetricsContext` (INHERIT).
        -   Base metrics: { effort: "Push Press", reps: 5, resistance: {value: 60, unit: "kg"} }.
        -   `EffortBlock` `leaves`. `ResultSpan`_PP1 created with these metrics.
    -   `EffortBlock` ("10 Cal Row") `enters`. `MetricsContext` (INHERIT).
        -   Base metrics: { effort: "Row", reps: 10, unit: "Cal" }.
        -   `EffortBlock` `leaves`. `ResultSpan`_Row1 created.
    -   `RepeatingBlock`'s `MetricsContext` might aggregate `ResultSpan`_PP1 and `ResultSpan`_Row1 for Round 1 summary if needed, or just store them.

3.  **Runtime - Rounds 2 & 3**: Similar flow, creating `ResultSpan`_PP2, `ResultSpan`_Row2, `ResultSpan`_PP3, `ResultSpan`_Row3.

4.  **`RepeatingBlock` Completion**:
    -   When `RepeatingBlock` `leaves`, its `enhanceResultSpan()` is called.
    -   It calculates its total metrics. This could be:
        -   Sum of all child `ResultSpan`s: (PP1+Row1) + (PP2+Row2) + (PP3+Row3).
        -   Or, if its base metric was "1 round", it might be { effort: "Rounds", reps: 3 } and the child spans are associated.
    -   A final `ResultSpan`_RepeatingBlock is generated.

5.  **UI Display**:
    -   Could show:
        -   Total workout summary from `RootBlock` (which aggregated `ResultSpan`_RepeatingBlock).
        -   Per-round breakdown (PP1+Row1, PP2+Row2, PP3+Row3).
        -   Individual exercise contributions (total Push Press reps/weight, total Row cals).

## 10. Extensibility

- **Adding New Metric Types**:
  1. Extend the `RuntimeMetric` interface in `timer.types.ts`.
  2. Update `MetricValue` if necessary.
  3. Modify parser/lexer and fragment types to capture the new data.
  4. Update reader functions (like `getMetrics`) to populate the new metric fields.
  5. Adjust `MetricsContext` and relevant block `enhanceResultSpan()` methods to handle/aggregate the new metric.
  6. Update UI components to display the new metric type.
- **Modifying Aggregation Logic**:
  1. Adjust `MetricsRelationshipType` logic in `MetricsContext`.
  2. Modify `enhanceResultSpan()` in specific block types.

This deep dive should clarify the intricacies of Wod.Wiki's runtime metrics system.
