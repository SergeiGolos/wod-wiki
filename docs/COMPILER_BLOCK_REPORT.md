# WOD Wiki Compiler Strategy & Block Report

This report details the block types generated by the WOD Wiki compiler, the strategies used to create them, and the specific fragments and output statements generated during execution.

## Core Runtime Mechanics

### 1. The Composition Pipeline (JIT Compiler)
The `JitCompiler` uses a set of `IRuntimeBlockStrategy` implementations sorted by priority.
- **Match Phase**: Strategies check the `ICodeStatement` (parsed from script) for specific fragments or hints.
- **Apply Phase**: Matching strategies use a `BlockBuilder` to compose the block by adding **Behaviors**.
- **Build Phase**: The `BlockBuilder` finalizes the block, automatically adding "Universal Invariants" like `ReentryCounterBehavior`.

### 2. Composition Aspects
The `BlockBuilder` provides "Aspect Composers" â€“ high-level methods that add a group of related behaviors:
- **`asTimer()`**: Adds `TimerInit`, `TimerTick`, `TimerPause`, and optionally `TimerCompletion`.
- **`asRepeater()`**: Adds `RoundInit`, `RoundAdvance`, and optionally `RoundCompletion`.
- **`asContainer()`**: Adds `ChildRunner` and optionally `ChildLoop`.

### 3. Output Statements vs. Events
- **Statements (`segment`, `completion`, `milestone`)**: Emitted by `SegmentOutputBehavior` and `RoundOutputBehavior`. These are visualized in the `Review` and `Track` screens.
- **Events (`history:record`)**: Emitted by `HistoryRecordBehavior` on unmount. These are used for data persistence and do not appear as rows in the output list.

---

## Behavior-to-Fragment Mapping

This table shows which behaviors are responsible for generating specific fragments in the block memory.

| Behavior | Tag | Fragment Type | Content / Value |
| :--- | :--- | :--- | :--- |
| **`TimerInitBehavior`** | `timer` | `Timer` | Initial duration, direction, role, and starting timestamp. |
| **`RoundInitBehavior`** | `round` | `Rounds` | Current round index and total rounds (if bounded). |
| **`RepSchemeBehavior`** | `fragment:rep-target` | `Rep` | Promoted rep count for the current round (e.g., "21" from 21-15-9). |
| **`SegmentOutputBehavior`** | (Output) | N/A | Merges `fragment:display`, `timer`, and `round` fragments into its output. |

---

## Strategy & Block Type Details

### 1. AMRAP Block
- **Strategy**: `AmrapLogicStrategy` (Priority 90)
- **Concept**: "As Many Rounds As Possible". Countdown timer controls block completion.
- **Trigger**: `Timer` fragment + (`Rounds` fragment OR "AMRAP"/"Rounds" keyword).
- **Behavior Composition**:
  - `asTimer` (Countdown, Primary, Complete: True)
  - `asRepeater` (Unbounded, Complete: False)
  - `RestBlockBehavior`, `SoundCueBehavior`, `DisplayInitBehavior`, `RoundDisplayBehavior`.
- **Outputs generated**:
  - `segment` (on mount): Shows AMRAP duration.
  - `milestone` (on mount/next): Shows current Round + Timer state.
  - `completion` (on unmount): Shows total time and final state.

### 2. EMOM Block
- **Strategy**: `IntervalLogicStrategy` (Priority 90)
- **Concept**: "Every Minute On the Minute". Timer resets per round; rounds control block completion.
- **Trigger**: `Timer` fragment + (Hint `repeating_interval` OR "EMOM" keyword).
- **Behavior Composition**:
  - `asTimer` (Countdown, Primary, Complete: True, `completesBlock: false`)
  - `asRepeater` (Fixed Rounds, Complete: True)
  - `RestBlockBehavior`, `SoundCueBehavior`, `DisplayInitBehavior`, `RoundDisplayBehavior`.
- **Outputs generated**:
  - `segment` (on mount): Shows interval duration.
  - `milestone` (on mount/next): Shows current Round + Reset Timer state.
  - `completion` (on unmount): Shows total time and final state.

### 3. For Time / Countdown Block
- **Strategy**: `GenericTimerStrategy` (Priority 50)
- **Concept**: Basic timer effort.
- **Trigger**: `Timer` fragment (and not matched by higher logic strategies).
- **Behavior Composition**:
  - `asTimer` (Direction/Duration from fragment. Complete: True if countdown).
  - `PopOnNextBehavior` (Manual advance allowed).
  - `DisplayInitBehavior`.
- **Outputs generated**:
  - `segment`, `completion`.

### 4. Rounds Block
- **Strategy**: `GenericLoopStrategy` (Priority 50)
- **Concept**: Fixed iteration without a specific pacing timer.
- **Trigger**: `Rounds` fragment.
- **Behavior Composition**:
  - `asRepeater` (Rounds from fragment. Complete: True).
  - `RepSchemeBehavior` (if fragment value is array like 21-15-9).
  - `DisplayInitBehavior`, `RoundDisplayBehavior`, `RoundOutputBehavior`.
- **Outputs generated**:
  - `segment`, `milestone`, `completion`.

### 5. Group Block
- **Strategy**: `GenericGroupStrategy` (Priority 50)
- **Concept**: Logical grouping (e.g., Super-sets).
- **Trigger**: Has children nodes but no timer/rounds fragments.
- **Behavior Composition**:
  - `asContainer` (Loop: True if rounds present from parent).
  - `DisplayInitBehavior`.
- **Outputs generated**:
  - **No output statements** by default (passed through to children).
  - `history:record` event on unmount.

### 6. Effort Block (Leaf)
- **Strategy**: `EffortFallbackStrategy` (Priority 0)
- **Concept**: Primitive exercise (e.g., "10 Burpees").
- **Trigger**: No Timer, No Rounds, No Children.
- **Behavior Composition**:
  - `asTimer` (**Secondary** Role, Countup).
  - `PopOnNextBehavior`.
  - `SegmentOutputBehavior`.
- **Outputs generated**:
  - `segment`, `completion`.
- **Generated Fragments**: The behavior calculates a `duration` fragment on unmount based on the secondary timer.

---

## Infrastructure / System Blocks

| Block Type | Creation Mechanism | Key Behaviors | Output Role |
| :--- | :--- | :--- | :--- |
| **Session Root** | `RuntimeFactory` | `SessionCompletionBehavior`, Primary Countup | Tracks total session time. |
| **Workout Root** | `WorkoutRootStrategy` | `ChildRunner`, `TimerInit` (Primary) | Tracks individual WOD timing. |
| **Rest** | `RestBlockStrategy` | `TimerInit` (Countdown), `SoundCue` | Emits "Rest" segment/completion. |
| **WaitingToStart**| `WaitingToStartStrategy`| `ButtonBehavior` ("Start"), `DisplayInit` | Idle gate before workout. |
| **Idle** | `IdleBlockStrategy` | `PopOnNext`, `PopOnEvent` | Transition states (e.g., "Ready"). |

---

## Visual State & Stack Identity

The code uses the `BlockKey` and `blockType` to identify what to show on the screen.
- **`Primary` Timer**: Displayed in the central clock. Only one "primary" timer is active at a time (usually from the leaf block, or the root if the leaf is secondary).
- **`Secondary` Timer**: Displayed alongside the block in the execution stack.
- **Labels**: Derived from the `fragment:label` memory location if present, otherwise from the block's `label` property.
- **Output Streaming**: The `Review` screen relies on the `segment` and `completion` statements emitted via the behaviors documented above.
