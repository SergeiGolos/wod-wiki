{
    "$schema": "https://aka.ms/codetour-schema",
    "title": "Test Runtime Architecture",
    "steps": [
        {
            "file": "src/runtime/testing/TestableRuntime.ts",
            "description": "## Test Runtime Architecture\n\nThe `TestableRuntime` class wraps the standard `IScriptRuntime` to provide enhanced capabilities for unit testing.\n\nIt allows for:\n1. **Operation Tracking**: Recording memory and stack operations.\n2. **State Snapshots**: capturing and diffing runtime state.\n3. **Event Simulation**: Driving the runtime with simulated events.\n4. **Test Setup**: Pre-populating memory and stack.",
            "line": 187
        },
        {
            "file": "src/runtime/testing/TestableRuntime.ts",
            "description": "### State Tracking\n\nWe maintain internal arrays for memory and stack operations, as well as snapshots.\n\nThis allows tests to assert that specific operations occurred or that the state changed in expected ways.",
            "line": 188
        },
        {
            "file": "src/runtime/testing/TestableRuntime.ts",
            "description": "### Wrapped Memory\n\nThe runtime wraps the real memory implementation with a proxy that records all operations (`allocate`, `get`, `set`) before delegating to the actual implementation.\n\nThis enables `expect(runtime.memoryOperations).toContain(...)` assertions.",
            "line": 658
        },
        {
            "file": "src/runtime/testing/TestableRuntime.ts",
            "description": "### Wrapped Stack\n\nSimilarly, the stack is wrapped using a `Proxy` to intercept `push` and `pop` operations.\n\nThis is useful for verifying that blocks are correctly pushed/popped during execution.",
            "line": 729
        },
        {
            "file": "src/runtime/testing/TestableRuntime.ts",
            "description": "### Snapshots & Diffing\n\n`snapshot()` captures the current state of the stack and memory.\n`diff()` compares two snapshots to show exactly what changed (allocated memory, modified values, pushed blocks).\n\nThis is a powerful tool for 'black box' testing of blocks.",
            "line": 344
        },
        {
            "file": "src/runtime/testing/TestableRuntime.ts",
            "description": "### Event Simulation\n\nMethods like `simulateTick`, `simulateNext`, and `simulateReps` inject synthetic events into the runtime event loop.\n\nThis allows tests to drive time forward or simulate user interactions without a real UI or clock.",
            "line": 405
        },
        {
            "file": "src/runtime/testing/TestableBlock.ts",
            "description": "## TestableBlock\n\n`TestableBlock` wraps `IRuntimeBlock` instances to intercept their lifecycle methods.\n\nIt supports different modes per method:\n- `'passthrough'`: Normal execution\n- `'spy'`: Record call and execute\n- `'override'`: Run custom logic\n- `'ignore'`: Do nothing",
            "line": 118
        },
        {
            "file": "src/runtime/testing/TestableBlock.ts",
            "description": "### Interception Logic\n\nThe `_intercept` method captures execution metrics (timestamp, duration) and method arguments.\n\nIt also handles the logic for switching between passthrough, spy, and override modes.",
            "line": 263
        }
    ]
}